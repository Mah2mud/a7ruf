<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>كلمات بذكاء • ذكاء اصطناعي</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        /* نفس الأنماط السابقة مع تحسينات للمساحة والتناسق */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --bg-soft: #f0f5fe;
            --card-bg: #ffffff;
            --primary: #1f3a6b;
            --accent: #f7b731;
            --accent-dark: #e6a523;
            --text-dark: #1f2a44;
            --success: #2e7d5e;
            --danger: #c44545;
            --shadow-sm: 0 8px 20px -8px rgba(0,20,40,0.15), 0 3px 8px rgba(0,0,0,0.05);
            --radius-card: 36px;
            --radius-item: 26px;
        }
        body {
            font-family: 'Cairo', 'Tajawal', sans-serif;
            background: linear-gradient(145deg, #d9e9fa, #ecf3fe);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            margin: 0;
        }
        .game-container {
            max-width: 500px;
            width: 100%;
            background: var(--card-bg);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.7);
            display: flex;
            flex-direction: column;
            max-height: 98vh; /* استخدام كامل الشاشة مع هامش بسيط */
        }
        .screen {
            padding: 16px 14px;
            display: none;
            animation: fadeUp 0.3s ease;
            flex: 1;
            overflow-y: auto; /* في حالة الحاجة للتمرير النادر، لكننا صممنا لتجنبه */
        }
        .screen.active { display: block; }
        @keyframes fadeUp {
            0% { opacity: 0.6; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* الشاشة الرئيسية */
        .start-screen { text-align: center; background: white; border-radius: var(--radius-card); }
        .game-title {
            font-size: 48px; font-weight: 900; color: var(--primary);
            line-height: 1.1; margin: 5px 0 0;
            text-shadow: 3px 3px 0 var(--accent);
        }
        .sub-title { font-size: 22px; font-weight: 600; color: #345; margin-bottom: 15px; }
        .features-grid {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
            margin: 15px 0 20px;
        }
        .feature-item {
            background: var(--bg-soft); border-radius: 60px; padding: 8px 18px;
            color: var(--primary); font-size: 16px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 6px;
            border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .feature-item i { color: var(--accent); font-size: 18px; }
        .btn-big {
            background: var(--primary); color: white; border: none;
            padding: 12px 35px; font-size: 32px; font-weight: 800;
            border-radius: 70px; cursor: pointer;
            box-shadow: 0 7px 0 #10233f, 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: 0.08s linear; border: 2px solid white;
            display: inline-flex; align-items: center; gap: 10px;
            margin: 0 auto 15px;
        }
        .btn-big:active { transform: translateY(5px); box-shadow: 0 2px 0 #10233f; }
        /* رأس اللعبة */
        .game-header {
            display: flex; flex-wrap: wrap; gap: 4px; justify-content: space-between;
            align-items: center; background: white; border-radius: 50px;
            padding: 5px 10px; margin-bottom: 10px; border: 1px solid #eef2f7;
        }
        .badge {
            background: var(--bg-soft); color: var(--text-dark); padding: 4px 10px;
            border-radius: 40px; font-size: 13px; font-weight: 700;
            display: flex; align-items: center; gap: 3px;
        }
        .badge i { color: var(--accent); font-size: 14px; }
        .timer-badge { background: #ffedd5; position: relative; overflow: hidden; }
        .timer-progress {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #fcd6a5; transform-origin: right; transition: transform 0.2s linear;
            z-index: 0; border-radius: 40px;
        }
        .badge span, .badge i { position: relative; z-index: 2; }
        .lives { display: flex; gap: 3px; margin: 0 2px; }
        .life-icon { font-size: 16px; color: #ff8a8a; }
        .shop-buttons { display: flex; gap: 4px; }
        .shop-btn {
            background: var(--bg-soft); border: 1px solid #d4e0f0; color: var(--primary);
            width: 34px; height: 34px; border-radius: 34px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; box-shadow: 0 3px 0 #c0cfdf;
            transition: 0.05s;
        }
        .shop-btn:active { transform: translateY(3px); box-shadow: none; }
        .shop-btn.disabled { opacity: 0.4; pointer-events: none; }
        /* حقل السؤال */
        .question-panel {
            background: white; border-radius: 40px; padding: 12px 12px;
            margin-bottom: 12px; border: 2px solid #eef3fc; box-shadow: 0 4px 0 #d9e2ef;
            text-align: center;
        }
        .word-length {
            background: var(--primary); color: white; padding: 3px 18px;
            border-radius: 50px; font-size: 14px; font-weight: 700;
            display: inline-block; margin-bottom: 6px;
        }
        .hint-text {
            font-size: 22px; color: var(--text-dark); font-weight: 700;
            line-height: 1.3; padding: 0 3px;
        }
        /* منطقة البناء */
        .build-area {
            background: #f6faff; border-radius: 40px; padding: 12px 10px;
            margin-bottom: 12px; border: 2px solid white;
        }
        .selected-letters {
            background: #eaf1fc; min-height: 65px; border-radius: 40px;
            display: flex; align-items: center; justify-content: center;
            flex-wrap: wrap; gap: 8px; padding: 10px; margin-bottom: 12px;
            border: 2px dashed #b3c7e3;
        }
        .letter-placed {
            background: var(--primary); color: white; font-size: 32px;
            font-weight: 800; width: 56px; height: 56px; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 3px solid var(--accent); box-shadow: 0 5px 0 #10233f;
            transition: 0.05s; flex-shrink: 0;
        }
        .letter-placed:active { transform: translateY(4px); box-shadow: 0 1px 0 #10233f; }
        .letters-pool {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .letter-btn {
            background: var(--accent); color: var(--primary); font-size: 40px;
            font-weight: 800; border: none; border-radius: 24px; cursor: pointer;
            box-shadow: 0 5px 0 #c57d1f; display: flex; align-items: center;
            justify-content: center; aspect-ratio: 1/1; width: 100%;
            border: 2px solid white; transition: 0.05s;
        }
        .letter-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #c57d1f; }
        .letter-btn.disabled, .letter-btn.hidden { opacity: 0.2; pointer-events: none; background: #ccc; box-shadow: none; border: 2px dashed #aaa; }
        /* الإحصائيات */
        .stats-panel {
            display: flex; flex-wrap: wrap; justify-content: space-between;
            background: white; border-radius: 40px; padding: 8px 12px;
            margin: 10px 0; color: #345; font-size: 13px; font-weight: 600;
            border: 1px solid #e2ecf9;
        }
        .stats-panel i { color: var(--accent); margin-left: 3px; }
        /* أزرار الإجراء */
        .action-buttons {
            display: flex; gap: 6px; flex-wrap: wrap;
        }
        .btn-action {
            background: white; color: var(--text-dark); border: 2px solid #dde5f0;
            padding: 8px 5px; font-size: 18px; border-radius: 50px; cursor: pointer;
            font-weight: 700; flex: 1 1 100px; display: flex; align-items: center;
            justify-content: center; gap: 4px; box-shadow: 0 4px 0 #d0dae8;
            transition: 0.05s;
        }
        .btn-action:active { transform: translateY(3px); box-shadow: 0 1px 0 #d0dae8; }
        .btn-action.check { background: #2e7d5e; color: white; border-color: #1f5e47; box-shadow: 0 4px 0 #1b4f3b; }
        .btn-action.reset { background: #f7b731; color: #1f2a44; border-color: #e09d30; box-shadow: 0 4px 0 #c48928; }
        .btn-action.new { background: #1f3a6b; color: white; border-color: #163153; box-shadow: 0 4px 0 #0f2642; }
        /* شاشة النهاية */
        .end-screen { text-align: center; background: white; border-radius: var(--radius-card); }
        .trophy-icon { font-size: 70px; color: var(--accent); margin: 5px 0 0; filter: drop-shadow(0 6px 8px #f7d98c); }
        .final-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
        .stat-card { background: var(--bg-soft); border-radius: 30px; padding: 12px 5px; }
        .stat-card .label { font-size: 16px; color: #456; }
        .stat-card .value { font-size: 36px; font-weight: 800; color: var(--primary); line-height: 1.1; }
        .btn-again {
            background: var(--primary); color: white; border: none; padding: 12px 35px;
            font-size: 30px; font-weight: 800; border-radius: 70px; cursor: pointer;
            box-shadow: 0 7px 0 #10233f; border: 2px solid white;
            display: inline-flex; align-items: center; gap: 10px; margin: 5px 0 10px;
        }
        .btn-again:active { transform: translateY(5px); box-shadow: 0 2px 0 #10233f; }
        /* Toast */
        .toast-notification {
            position: fixed; bottom: 20px; left: 20px; right: 20px; margin: 0 auto;
            max-width: 300px; background: #1e3c72; color: white; padding: 10px 16px;
            border-radius: 60px; font-size: 18px; font-weight: 600; border: 2px solid var(--accent);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 10001; display: none;
            align-items: center; justify-content: center; gap: 6px; text-align: center;
        }
        .toast-notification.show { display: flex; animation: toastInOut 3s ease forwards; }
        @keyframes toastInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        /* تكيف للجوال الصغير */
        @media (max-width: 400px) {
            .game-title { font-size: 40px; }
            .btn-big { font-size: 26px; padding: 10px 25px; }
            .letter-btn { font-size: 36px; }
            .letter-placed { width: 50px; height: 50px; font-size: 28px; }
            .btn-action { font-size: 16px; padding: 6px 3px; }
            .badge { font-size: 12px; padding: 4px 8px; }
            .feature-item { font-size: 14px; padding: 6px 14px; }
        }
        /* للشاشات القصيرة جداً، تقليل المسافات */
        @media (max-height: 700px) {
            .game-header { padding: 4px 8px; margin-bottom: 6px; }
            .question-panel { padding: 8px; margin-bottom: 6px; }
            .hint-text { font-size: 20px; }
            .selected-letters { min-height: 55px; padding: 6px; gap: 5px; }
            .letter-placed { width: 46px; height: 46px; font-size: 26px; }
            .letters-pool { gap: 5px; }
            .stats-panel { padding: 5px 8px; margin: 5px 0; font-size: 12px; }
            .btn-action { padding: 6px 3px; font-size: 16px; }
        }
    </style>
</head>
<body>
<!-- Toast -->
<div id="toast" class="toast-notification"><i class="fas fa-info-circle"></i><span id="toastMessage"></span></div>

<div class="game-container">
    <!-- شاشة البداية -->
    <div id="startScreen" class="screen start-screen active">
        <h1 class="game-title">كلمات بذكاء</h1>
        <div class="sub-title">توليد ذكي لكل كلمة</div>
        <div class="features-grid">
            <span class="feature-item"><i class="fas fa-robot"></i> كلمات لا نهائية</span>
            <span class="feature-item"><i class="fas fa-brain"></i> تلميحات ذكية</span>
            <span class="feature-item"><i class="fas fa-hourglass-half"></i> سباق مع الوقت</span>
            <span class="feature-item"><i class="fas fa-store"></i> متجر المساعدات</span>
        </div>
        <button class="btn-big" onclick="startGame()"><i class="fas fa-play"></i> ابدأ</button>
    </div>

    <!-- شاشة اللعب -->
    <div id="gameScreen" class="screen game-screen">
        <div class="game-header">
            <div class="badge"><i class="fas fa-signal"></i> مستوى <span id="levelDisplay">1</span></div>
            <div class="badge"><i class="fas fa-coins"></i> <span id="scoreDisplay">0</span></div>
            <div class="badge timer-badge">
                <i class="fas fa-hourglass-half"></i> <span id="timerDisplay">60</span>
                <div class="timer-progress" id="timerProgress"></div>
            </div>
            <div class="lives" id="livesContainer">
                <i class="fas fa-heart life-icon"></i><i class="fas fa-heart life-icon"></i><i class="fas fa-heart life-icon"></i>
            </div>
            <div class="shop-buttons">
                <div class="shop-btn" onclick="buyHint()" id="hintShopBtn"><i class="fas fa-lightbulb"></i></div>
                <div class="shop-btn" onclick="buyTime()" id="timeShopBtn"><i class="fas fa-hourglass-start"></i></div>
            </div>
        </div>

        <div class="question-panel">
            <span class="word-length" id="wordLengthInfo">كلمة من 3 أحرف</span>
            <div class="hint-text" id="hintText">✨ يـتـم الـتـحـمـيـل ✨</div>
        </div>

        <div class="build-area">
            <div class="selected-letters" id="selectedArea"></div>
            <div class="letters-pool" id="lettersGrid"></div>
        </div>

        <div class="stats-panel">
            <span><i class="fas fa-clock"></i> <span id="timeLeft">60</span> ث</span>
            <span><i class="fas fa-chart-line"></i> مستوى <span id="currentLevelSpan">1</span></span>
            <span><i class="fas fa-check-circle"></i> <span id="solvedCount">0</span></span>
            <span><i class="fas fa-asterisk"></i> <span id="uniqueCountSpan">0</span></span>
            <span><i class="fas fa-trophy"></i> XP <span id="xpDisplay">0</span></span>
        </div>

        <div class="action-buttons">
            <button class="btn-action check" onclick="checkAnswer()"><i class="fas fa-check"></i> تحقق</button>
            <button class="btn-action reset" onclick="resetCurrent()"><i class="fas fa-undo-alt"></i> أعد</button>
            <button class="btn-action new" onclick="forceNewChallenge()"><i class="fas fa-random"></i> جديد</button>
        </div>
    </div>

    <!-- شاشة النهاية -->
    <div id="endScreen" class="screen end-screen">
        <i class="fas fa-crown trophy-icon"></i>
        <h2 style="font-size: 38px; color:var(--primary);">أحسنت!</h2>
        <div class="final-stats-grid">
            <div class="stat-card"><div class="label">النقاط</div><div class="value" id="finalScore">0</div></div>
            <div class="stat-card"><div class="label">أعلى مستوى</div><div class="value" id="finalLevel">1</div></div>
            <div class="stat-card"><div class="label">كلمات محلولة</div><div class="value" id="finalSolved">0</div></div>
            <div class="stat-card"><div class="label">كلمات مختلفة</div><div class="value" id="finalUnique">0</div></div>
        </div>
        <button class="btn-again" onclick="restartGame()"><i class="fas fa-redo-alt"></i> مرة أخرى</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // ==================== إعدادات اللعبة والمفاتيح ====================
    const GEMINI_API_KEY = 'AIzaSyAK6KpNlC3k8O_dIQkoXmhLQRlIzGoFcZo';
    const CONFIG = {
        START_TIME: 60, // تم التعديل: بدلاً من 30 أصبح 60 ثانية (دقيقة)
        MIN_TIME: 5,
        TIME_DECREASE: 0.85,
        SCORE_PER_LETTER: 10,
        MAX_LETTERS: 6,
        MIN_LETTERS: 3,
        MAX_RETRIES: 4,          // زيادة عدد المحاولات
        HINT_COST: 30,
        TIME_COST: 20,
        EXTRA_TIME: 10,
        LIVES: 3,
        XP_PER_CORRECT: 20,
        USED_WORDS_LIMIT: 100,    // حد أقصى للكلمات المحفوظة (لتجنب التكرار المطلق)
    };

    const game = {
        level: 1,
        score: 0,
        xp: 0,
        timeLeft: CONFIG.START_TIME,
        lives: CONFIG.LIVES,
        active: true,
        currentWord: '',
        currentHint: '',
        shuffledLetters: [],
        selectedLetters: [],
        wordsSolved: 0,
        usedWords: new Set(),
        hardestWord: '',
        timer: null,
        hintsAvailable: 0,
    };

    // عناصر الواجهة
    const ui = {
        startScreen: document.getElementById('startScreen'),
        gameScreen: document.getElementById('gameScreen'),
        endScreen: document.getElementById('endScreen'),
        levelDisplay: document.getElementById('levelDisplay'),
        scoreDisplay: document.getElementById('scoreDisplay'),
        timerDisplay: document.getElementById('timerDisplay'),
        timerProgress: document.getElementById('timerProgress'),
        wordLengthInfo: document.getElementById('wordLengthInfo'),
        hintText: document.getElementById('hintText'),
        selectedArea: document.getElementById('selectedArea'),
        lettersGrid: document.getElementById('lettersGrid'),
        timeLeft: document.getElementById('timeLeft'),
        currentLevelSpan: document.getElementById('currentLevelSpan'),
        solvedCount: document.getElementById('solvedCount'),
        uniqueCountSpan: document.getElementById('uniqueCountSpan'),
        xpDisplay: document.getElementById('xpDisplay'),
        livesContainer: document.getElementById('livesContainer'),
        finalScore: document.getElementById('finalScore'),
        finalLevel: document.getElementById('finalLevel'),
        finalSolved: document.getElementById('finalSolved'),
        finalUnique: document.getElementById('finalUnique'),
        hintShopBtn: document.getElementById('hintShopBtn'),
        timeShopBtn: document.getElementById('timeShopBtn'),
        toast: document.getElementById('toast'),
        toastMessage: document.getElementById('toastMessage'),
    };

    // ==================== قاموس احتياطي كبير (أكثر من 100 كلمة) ====================
    const FALLBACK_DICT = [
        { word: 'كتاب', hint: 'نقرأ فيه القصص', length: 4 },
        { word: 'قلم', hint: 'نكتب به', length: 3 },
        { word: 'بيت', hint: 'نسكن فيه', length: 3 },
        { word: 'شمس', hint: 'تشرق في الصباح', length: 3 },
        { word: 'قمر', hint: 'يضيء الليل', length: 3 },
        { word: 'ورد', hint: 'زهرة جميلة', length: 3 },
        { word: 'نحلة', hint: 'تصنع عسلاً', length: 4 },
        { word: 'أسد', hint: 'ملك الغابة', length: 3 },
        { word: 'فيل', hint: 'حيوان ضخم له خرطوم', length: 3 },
        { word: 'زرافة', hint: 'حيوان طويل العنق', length: 5 },
        { word: 'تمساح', hint: 'زاحف مفترس', length: 5 },
        { word: 'دجاجة', hint: 'تلد بيضاً', length: 5 },
        { word: 'حمامة', hint: 'طائر أبيض رمز السلام', length: 5 },
        { word: 'بلبل', hint: 'طائر يغرد', length: 4 },
        { word: 'سمكة', hint: 'تعيش في الماء', length: 4 },
        { word: 'سلحفاة', hint: 'بطيئة وتحمل بيتها', length: 6 },
        { word: 'نخلة', hint: 'شجرة تنتج التمر', length: 4 },
        { word: 'زيتون', hint: 'شجر مبارك', length: 5 },
        { word: 'تفاح', hint: 'فاكهة حمراء أو خضراء', length: 4 },
        { word: 'موز', hint: 'فاكهة صفراء', length: 3 },
        { word: 'عنب', hint: 'فاكهة صغيرة حلوة', length: 3 },
        { word: 'برتقال', hint: 'فاكهة حمضية برتقالية', length: 6 },
        { word: 'بطيخ', hint: 'فاكهة كبيرة خضراء', length: 5 },
        { word: 'جزر', hint: 'خضار برتقالي', length: 3 },
        { word: 'خيار', hint: 'خضار أخضر طويل', length: 4 },
        { word: 'طماطم', hint: 'خضار أحمر', length: 5 },
        { word: 'بصل', hint: 'يبكي من يقطعه', length: 3 },
        { word: 'ثوم', hint: 'يضاف للطعام لرائحة نفاذة', length: 3 },
        { word: 'فلفل', hint: 'حار أو بارد', length: 4 },
        { word: 'مدرسة', hint: 'نتعلم فيها', length: 5 },
        { word: 'معلم', hint: 'يشرح الدرس', length: 4 },
        { word: 'طالب', hint: 'يتعلم في المدرسة', length: 4 },
        { word: 'حقيبة', hint: 'نحمل فيها الكتب', length: 5 },
        { word: 'سبورة', hint: 'نكتب عليها بالطباشير', length: 6 },
        { word: 'كرسي', hint: 'نجلس عليه', length: 4 },
        { word: 'طاولة', hint: 'نأكل عليها', length: 5 },
        { word: 'سرير', hint: 'ننام عليه', length: 4 },
        { word: 'ثلاجة', hint: 'نحفظ فيها الطعام', length: 6 },
        { word: 'فرن', hint: 'نطبخ فيه', length: 3 },
        { word: 'مطبخ', hint: 'نعد الطعام فيه', length: 5 },
        { word: 'حمام', hint: 'نستحم فيه', length: 4 },
        { word: 'حديقة', hint: 'فيها أزهار وأشجار', length: 5 },
        { word: 'شجرة', hint: 'تعطينا ظلاً', length: 4 },
        { word: 'غيمة', hint: 'تمطر مطراً', length: 4 },
        { word: 'مطر', hint: 'ينزل من السماء', length: 3 },
        { word: 'ثلج', hint: 'أبيض بارد', length: 3 },
        { word: 'نار', hint: 'ساخنة تحرق', length: 3 },
        { word: 'بحر', hint: 'واسع من الماء', length: 3 },
        { word: 'جبل', hint: 'عالٍ جداً', length: 3 },
        { word: 'وادي', hint: 'منخفض بين جبلين', length: 4 },
        { word: 'صحراء', hint: 'جافة وقاحلة', length: 5 },
        { word: 'سحاب', hint: 'يحمل المطر', length: 4 },
        { word: 'طائرة', hint: 'تطير في السماء', length: 5 },
        { word: 'سيارة', hint: 'نركبها للذهاب', length: 5 },
        { word: 'قطار', hint: 'يسير على قضبان', length: 4 },
        { word: 'سفينة', hint: 'تبحر في البحر', length: 5 },
        { word: 'دراجة', hint: 'نركبها وندوس', length: 5 },
        { word: 'كرة', hint: 'نلعب بها', length: 3 },
        { word: 'لعبة', hint: 'نستمتع بها', length: 4 },
        { word: 'دمية', hint: 'نلعب بها', length: 4 },
        { word: 'بالون', hint: 'ينتفخ بالهواء', length: 5 },
        { word: 'هدية', hint: 'نفرح بها', length: 4 },
        { word: 'عيد', hint: 'نفرح فيه', length: 3 },
        { word: 'صديق', hint: 'نحب قربه', length: 4 },
        { word: 'أخ', hint: 'شقيق', length: 2 },
        { word: 'أخت', hint: 'شقيقة', length: 3 },
        { word: 'أم', hint: 'أغلى إنسانة', length: 2 },
        { word: 'أب', hint: 'سند العائلة', length: 2 },
        { word: 'جد', hint: 'والد الوالد', length: 2 },
        { word: 'جدة', hint: 'والدة الوالد', length: 3 },
    ];

    // ==================== دوال مساعدة ====================
    function showToast(msg, icon = '✨') {
        ui.toastMessage.textContent = msg;
        ui.toast.classList.add('show');
        setTimeout(() => ui.toast.classList.remove('show'), 2800);
    }

    function showScreen(screenId) {
        ui.startScreen.classList.remove('active');
        ui.gameScreen.classList.remove('active');
        ui.endScreen.classList.remove('active');
        if (screenId === 'start') ui.startScreen.classList.add('active');
        else if (screenId === 'game') ui.gameScreen.classList.add('active');
        else if (screenId === 'end') ui.endScreen.classList.add('active');
    }

    // حفظ الكلمات المستخدمة مع حد أقصى
    function loadUsedWords() {
        try {
            const saved = localStorage.getItem('kw_usedWords_pro');
            if (saved) game.usedWords = new Set(JSON.parse(saved));
        } catch (e) {}
    }
    function saveUsedWords() {
        try {
            // إذا تجاوزت المجموعة الحد، نحتفظ بآخر 100 كلمة فقط
            if (game.usedWords.size > CONFIG.USED_WORDS_LIMIT) {
                const arr = Array.from(game.usedWords).slice(-CONFIG.USED_WORDS_LIMIT);
                game.usedWords = new Set(arr);
            }
            localStorage.setItem('kw_usedWords_pro', JSON.stringify(Array.from(game.usedWords)));
        } catch (e) {}
    }

    // تحديث كل شاشة اللعب
    function refreshUI() {
        ui.levelDisplay.textContent = game.level;
        ui.scoreDisplay.textContent = game.score;
        ui.timerDisplay.textContent = game.timeLeft;
        ui.timeLeft.textContent = game.timeLeft;
        ui.currentLevelSpan.textContent = game.level;
        ui.solvedCount.textContent = game.wordsSolved;
        ui.uniqueCountSpan.textContent = game.usedWords.size;
        ui.xpDisplay.textContent = game.xp;

        // شريط التقدم للمؤقت
        let maxTime = Math.max(CONFIG.MIN_TIME, Math.floor(CONFIG.START_TIME * Math.pow(CONFIG.TIME_DECREASE, game.level - 1)));
        let percent = game.timeLeft / maxTime;
        ui.timerProgress.style.transform = `scaleX(${Math.max(0, percent)})`;
        if (game.timeLeft <= 10) ui.timerProgress.style.backgroundColor = '#ffae7a';
        else ui.timerProgress.style.backgroundColor = '#fcd6a5';

        // عرض الأرواح
        ui.livesContainer.innerHTML = '';
        for (let i = 0; i < CONFIG.LIVES; i++) {
            let heart = document.createElement('i');
            heart.className = i < game.lives ? 'fas fa-heart life-icon' : 'far fa-heart life-icon';
            heart.style.color = i < game.lives ? '#ff6b6b' : '#ccb6b6';
            ui.livesContainer.appendChild(heart);
        }

        // أزرار المتجر
        ui.hintShopBtn.classList.toggle('disabled', game.score < CONFIG.HINT_COST);
        ui.timeShopBtn.classList.toggle('disabled', game.score < CONFIG.TIME_COST);
    }

    // خلط الأحرف
    function shuffle(word) {
        const arr = word.split('');
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // عرض الأحرف المتاحة
    function displayLetters() {
        ui.lettersGrid.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const btn = document.createElement('button');
            btn.className = 'letter-btn';
            if (i < game.shuffledLetters.length) {
                btn.textContent = game.shuffledLetters[i];
                btn.onclick = () => selectLetter(i);
            } else {
                btn.classList.add('hidden');
                btn.disabled = true;
            }
            ui.lettersGrid.appendChild(btn);
        }
    }

    // عرض الأحرف المختارة
    function displaySelected() {
        ui.selectedArea.innerHTML = '';
        game.selectedLetters.forEach((letter, idx) => {
            const span = document.createElement('span');
            span.className = 'letter-placed';
            span.textContent = letter;
            span.onclick = () => returnLetter(idx);
            ui.selectedArea.appendChild(span);
        });
    }

    function selectLetter(index) {
        if (!game.active) return;
        const letter = game.shuffledLetters[index];
        game.selectedLetters.push(letter);
        game.shuffledLetters.splice(index, 1);
        displayLetters(); displaySelected();
    }

    function returnLetter(index) {
        if (!game.active) return;
        const letter = game.selectedLetters[index];
        game.shuffledLetters.push(letter);
        game.selectedLetters.splice(index, 1);
        displayLetters(); displaySelected();
    }

    function resetCurrent() {
        if (!game.active || !game.currentWord) return;
        game.shuffledLetters = shuffle(game.currentWord);
        game.selectedLetters = [];
        displayLetters(); displaySelected();
        playSound('click');
    }

    // ==================== توليد الكلمة عبر الذكاء الاصطناعي مع نظام احتياطي قوي ====================
    async function fetchNewWord() {
        // عرض تحميل بسيط
        Swal.fire({
            title: 'جاري التوليد...',
            text: 'الذكاء الاصطناعي يبتكر كلمة جديدة',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
            background: '#1f3a6b',
            color: 'white',
            timer: 10000, // حد أقصى 10 ثوان
        });

        const wordLength = Math.min(CONFIG.MAX_LETTERS, CONFIG.MIN_LETTERS + Math.floor(game.level / 3));
        const topics = ['المنزل', 'المدرسة', 'الحديقة', 'المطبخ', 'الحيوانات', 'الفواكه', 'المشاعر', 'الألوان', 'المهن', 'الطبيعة', 'الفضاء', 'الرياضة', 'الملابس'];
        const topic = topics[Math.floor(Math.random() * topics.length)];

        let attempts = 0;
        while (attempts < CONFIG.MAX_RETRIES) {
            attempts++;
            try {
                // نضيف رقم عشوائي للحصول على تنوع أكبر
                const randomSeed = Math.floor(Math.random() * 1000);
                const prompt = `أنت مساعد أطفال. اكتب كلمة عربية من ${wordLength} أحرف (بدون تشكيل) عن موضوع "${topic}" (التنويع: ${randomSeed}). يجب أن تكون الكلمة مناسبة للأطفال ولها معنى واضح. أعد JSON فقط: {"word": "...", "hint": "..."}. تأكد أن الكلمة غير مكررة في الاستخدام.`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (!data.candidates) continue;
                const text = data.candidates[0].content.parts[0].text;
                const match = text.match(/\{[\s\S]*\}/);
                if (!match) continue;
                const result = JSON.parse(match[0]);
                // التحقق من أن الكلمة بنفس الطول المطلوب (تقريباً)
                if (result.word && result.hint && result.word.length === wordLength && !game.usedWords.has(result.word)) {
                    Swal.close();
                    return result;
                }
            } catch (e) {
                console.warn('API attempt failed', e);
            }
        }

        // إذا فشلت كل المحاولات، نستخدم القاموس الاحتياطي
        Swal.close();
        
        // تصفية الكلمات الاحتياطية حسب الطول المطلوب وعدم التكرار
        let suitableFallback = FALLBACK_DICT.filter(item => item.length === wordLength && !game.usedWords.has(item.word));
        
        // إذا لم نجد كلمة بنفس الطول، نوسع البحث لأي طول (مع تجنب التكرار)
        if (suitableFallback.length === 0) {
            suitableFallback = FALLBACK_DICT.filter(item => !game.usedWords.has(item.word));
        }
        
        // إذا كان لا يزال فارغاً (نادر)، نستخدم أي كلمة من القاموس حتى لو تكررت
        if (suitableFallback.length === 0) {
            suitableFallback = FALLBACK_DICT;
        }
        
        // اختيار عشوائي من القائمة
        const randomFallback = suitableFallback[Math.floor(Math.random() * suitableFallback.length)];
        return { word: randomFallback.word, hint: randomFallback.hint };
    }

    async function newChallenge() {
        if (!game.active) return;
        const wordData = await fetchNewWord();
        game.currentWord = wordData.word;
        game.currentHint = wordData.hint;
        game.usedWords.add(wordData.word);
        saveUsedWords();  // حفظ بعد الإضافة

        ui.hintText.textContent = game.currentHint;
        ui.wordLengthInfo.textContent = `كلمة من ${game.currentWord.length} أحرف`;

        game.shuffledLetters = shuffle(game.currentWord);
        game.selectedLetters = [];
        displayLetters(); displaySelected();

        game.level++; // يصبح التحدي أصعب قليلاً
        refreshUI();
        playSound('new');
    }

    async function forceNewChallenge() {
        if (!game.active) return;
        await newChallenge();
    }

    // ==================== التحقق من الإجابة ====================
    function checkAnswer() {
        if (!game.active || !game.currentWord) return;
        const userWord = game.selectedLetters.join('');
        if (userWord === game.currentWord) {
            // إجابة صحيحة
            const points = game.currentWord.length * CONFIG.SCORE_PER_LETTER;
            game.score += points;
            game.xp += CONFIG.XP_PER_CORRECT;
            game.wordsSolved++;

            // مكافأة الوقت: ثانية لكل حرف
            const timeBonus = game.currentWord.length;
            game.timeLeft += timeBonus;
            showToast(`✓ صحيح! +${points} نقطة و +${timeBonus} ث`, '✅');

            // تأثير بصري
            document.querySelector('.question-panel').style.backgroundColor = '#e0f5e9';
            setTimeout(() => document.querySelector('.question-panel').style.backgroundColor = '', 300);

            playSound('correct');
            refreshUI();
            newChallenge(); // كلمة جديدة
        } else {
            // إجابة خاطئة
            game.score = Math.max(0, game.score - 5);
            game.lives--;
            document.querySelector('.build-area').style.backgroundColor = '#ffe1e1';
            setTimeout(() => document.querySelector('.build-area').style.backgroundColor = '', 300);
            showToast('✗ إجابة خاطئة -5 نقاط', '❌');
            playSound('wrong');
            refreshUI();

            if (game.lives <= 0) {
                endGame();
            }
        }
    }

    // ==================== المؤقت ====================
    function startTimer() {
        if (game.timer) clearInterval(game.timer);
        game.timer = setInterval(() => {
            if (!game.active) return;
            game.timeLeft--;
            refreshUI();
            if (game.timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    }

    // ==================== المتجر ====================
    function buyHint() {
        if (game.score < CONFIG.HINT_COST) {
            Swal.fire({ icon: 'warning', title: 'نقاط غير كافية', text: `تحتاج ${CONFIG.HINT_COST} نقطة`, background: '#1f3a6b', color: 'white' });
            return;
        }
        game.score -= CONFIG.HINT_COST;
        Swal.fire({
            icon: 'info', title: 'تلميح', text: `الحرف الأول: "${game.currentWord[0]}"`,
            background: '#1f3a6b', color: 'white'
        });
        refreshUI();
    }

    function buyTime() {
        if (game.score < CONFIG.TIME_COST) {
            Swal.fire({ icon: 'warning', title: 'نقاط غير كافية', text: `تحتاج ${CONFIG.TIME_COST} نقطة`, background: '#1f3a6b', color: 'white' });
            return;
        }
        game.score -= CONFIG.TIME_COST;
        game.timeLeft += CONFIG.EXTRA_TIME;
        showToast(`⏳ +${CONFIG.EXTRA_TIME} ثانية`, '⏳');
        refreshUI();
    }

    // ==================== إنهاء اللعبة ====================
    function endGame() {
        game.active = false;
        clearInterval(game.timer);
        ui.finalScore.textContent = game.score;
        ui.finalLevel.textContent = game.level;
        ui.finalSolved.textContent = game.wordsSolved;
        ui.finalUnique.textContent = game.usedWords.size;
        showScreen('end');
        playSound('gameover');
        try { localStorage.setItem('kw_bestScore', Math.max(game.score, localStorage.getItem('kw_bestScore')||0)); } catch(e) {}
    }

    // بدء اللعبة
    function startGame() {
        loadUsedWords();
        game.active = true;
        game.level = 1;
        game.score = 0;
        game.xp = 0;
        game.wordsSolved = 0;
        game.lives = CONFIG.LIVES;
        game.timeLeft = CONFIG.START_TIME;
        game.currentWord = '';
        game.hintsAvailable = 0;
        showScreen('game');
        startTimer();
        newChallenge();
        playSound('start');
    }

    function restartGame() { startGame(); }

    // مؤثرات صوتية بسيطة
    let audioCtx = null;
    function playSound(type) {
        if (!audioCtx) {
            try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { return; }
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = 'sine';
        let freq = 400, duration = 0.15;
        if (type === 'correct') { freq = 700; duration = 0.12; }
        else if (type === 'wrong') { freq = 200; duration = 0.2; }
        else if (type === 'new') { freq = 850; duration = 0.1; }
        else if (type === 'gameover') { freq = 150; duration = 0.5; }
        else if (type === 'start') { freq = 950; duration = 0.2; }
        else if (type === 'click') { freq = 520; duration = 0.05; }
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    // ربط الدوال العامة
    window.startGame = startGame;
    window.checkAnswer = checkAnswer;
    window.resetCurrent = resetCurrent;
    window.forceNewChallenge = forceNewChallenge;
    window.restartGame = restartGame;
    window.buyHint = buyHint;
    window.buyTime = buyTime;

    // تهيئة الصوت عند أول تفاعل
    document.body.addEventListener('click', function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }, { once: true });

    // تحميل الكلمات المستخدمة عند البداية
    loadUsedWords();
</script>
</body>
</html>